//+------------------------------------------------------------------+
//|                                                       Test 3.mq4 |
//|                        Copyright 2020, MetaQuotes Software Corp. |
//|                                             https://www.mql5.com |
//+------------------------------------------------------------------+
#property copyright "Copyright 2020, MetaQuotes Software Corp."
#property link      "https://www.mql5.com"
#property version   "1.00"
#property strict
#property show_inputs
#include <CustomFunctions01.mqh>

double balance = AccountBalance();
input double risk = 0.03;
input int slippage = 5;
input int sl = 200;
double lot = OptimalLotSize(risk,sl);
//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
//---
   Alert("EA is on");
   DayOfWeekAlert();
   IsTradingAllowed();
//---
   return(INIT_SUCCEEDED);
  }
//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
  {
//---
   Alert("EA is off");
  }
//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
  {
//---
   double preEmaL = NormalizeDouble(iMA(NULL,0,48,2,1,0,0),3);
   double preEmaS = NormalizeDouble(iMA(NULL,0,13,2,1,0,0),3);
   double curEmaL = NormalizeDouble(iMA(NULL,0,48,1,1,0,0),4);
   double curEmaS = NormalizeDouble(iMA(NULL,0,13,1,1,0,0),4);
   double preRsi = NormalizeDouble(iRSI(NULL,0,14,0,2),2);
   double curRsi = NormalizeDouble(iRSI(NULL,0,14,0,1),2);
   
   if (OrdersTotal() == 0){
   if(preEmaS == preEmaL && curEmaS > curEmaL && curRsi < 66.66 && curRsi > 50){
   int ticket = OrderSend(NULL,0,lot,Ask,slippage,NULL,NULL);
   } else if(preEmaS == preEmaL && curEmaS < curEmaL && curRsi > 33.33 && curRsi < 50){
   int ticket = OrderSend(NULL,1,lot,Bid,slippage,NULL,NULL);
   }}
   
   if (OrdersTotal() == 1){
   if (OrderSelect(0,SELECT_BY_POS) == true){
   int order = OrderTicket();
   if(curRsi > 66.66 || curRsi < 50){
   OrderClose(order,lot,Bid,slippage,clrNONE);
   } else if (curRsi < 33.33 || curRsi > 50){
   OrderClose(order,lot,Ask,slippage,clrNONE);
   }}}
  }
//+------------------------------------------------------------------+
